<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AnimeAI Demo</title>
  <style>
    body { margin:0; font-family: Arial, sans-serif; background:#f7f9fc; display:flex; flex-direction:column; align-items:center; }
    header { width:100%; background:#8A2BE2; color:#fff; display:flex; justify-content:space-between; align-items:center; padding:10px 16px; }
    .menu-buttons button { background:none; border:none; color:#fff; font-size:18px; cursor:pointer; margin-left:10px; }
    .container { width:100%; max-width:600px; padding:16px; }
    .character-area { width:100%; height:300px; background:#eef2ff; border-radius:8px; display:flex; justify-content:center; align-items:center; position:relative; overflow:hidden; }
    .character-area img { max-width:90%; max-height:90%; transition:transform 0.3s ease, filter 0.3s ease; }
    #speechBubble { position:absolute; top:20px; background:#fff; padding:10px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); opacity:0; transition:opacity 0.3s ease; }
    #speechBubble.active { opacity:1; }
    .chat-log { margin-top:16px; height:200px; overflow-y:auto; background:#fff; border-radius:8px; padding:10px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    .chat-message { margin-bottom:8px; }
    .chat-message.user { text-align:right; }
    .input-area { display:flex; margin-top:10px; gap:8px; }
    .input-area input { flex:1; padding:8px; border:1px solid #ccc; border-radius:4px; }
    .input-area button { padding:8px 16px; background:#8A2BE2; color:#fff; border:none; border-radius:4px; cursor:pointer; }
    .generate-area { display:flex; flex-direction:column; margin-top:16px; gap:8px; }
    .generate-area input[type="text"] { flex:1; }
    .generate-area label { display:flex; align-items:center; gap:4px; font-size:14px; }
  </style>
</head>
<body>
  <header>
    <div>AnimeAI</div>
    <div class="menu-buttons">
      <button id="voiceMode">üîä</button>
      <button id="videoMode">üìû</button>
      <button id="settingsBtn">‚öôÔ∏è</button>
    </div>
  </header>
  <div class="container">
    <div class="character-area">
      <img id="characterImage" src="/assets/character_images/gyaru.png" alt="character">
      <div id="speechBubble"></div>
    </div>
    <div class="chat-log" id="chatLog"></div>
    <div class="input-area">
      <input type="text" id="messageInput" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
      <button id="sendButton">Î≥¥ÎÇ¥Í∏∞</button>
    </div>
    <div class="generate-area">
      <input type="file" id="imageInput" accept="image/*">
      <input type="text" id="promptInput" placeholder="Ï∫êÎ¶≠ÌÑ∞ ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
      <label><input type="checkbox" id="animateCheckbox"> animate</label>
      <button id="generateButton">Ï∫êÎ¶≠ÌÑ∞ ÏÉùÏÑ±</button>
    </div>
  </div>
  <script>
    const characterImage = document.getElementById('characterImage');
    const speechBubble = document.getElementById('speechBubble');
    const chatLog = document.getElementById('chatLog');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const promptInput = document.getElementById('promptInput');
    const generateButton = document.getElementById('generateButton');
    const imageInput = document.getElementById('imageInput');
    const animateCheckbox = document.getElementById('animateCheckbox');

    let chatHistory = [];
    let speakingInterval = null;
    const emotionStyles = {
      neutral:{transform:'translateY(0)',filter:'brightness(1)'},
      happy:{transform:'translateY(-10px)',filter:'brightness(1.1)'},
      sad:{transform:'translateY(5px)',filter:'brightness(0.9)'},
      angry:{transform:'translateY(-5px)',filter:'brightness(1.05)'},
      surprised:{transform:'translateY(-15px)',filter:'brightness(1.15)'}
    };
    let currentEmotion = 'neutral';
    function changeEmotion(em){
      currentEmotion = emotionStyles[em] ? em : 'neutral';
      characterImage.style.transform = emotionStyles[currentEmotion].transform;
      characterImage.style.filter = emotionStyles[currentEmotion].filter;
    }
    function speak(text){
      if(!text) return;
      speechBubble.textContent = text;
      speechBubble.classList.add('active');
      const base = emotionStyles[currentEmotion].transform;
      clearInterval(speakingInterval);
      speakingInterval = setInterval(()=>{
        const offsetX = (Math.random()-0.5)*4;
        const offsetY = (Math.random()-0.5)*4;
        characterImage.style.transform = `${base} translate(${offsetX}px,${offsetY}px)`;
      },100);
      setTimeout(()=>{ stopSpeaking(); }, Math.max(2000,text.length*100));
    }
    function stopSpeaking(){
      clearInterval(speakingInterval);
      characterImage.style.transform = emotionStyles[currentEmotion].transform;
      speechBubble.classList.remove('active');
    }
    function appendMessage(role,text){
      const div=document.createElement('div');
      div.className='chat-message '+role;
      div.textContent=text;
      chatLog.appendChild(div);
      chatLog.scrollTop=chatLog.scrollHeight;
    }
    sendButton.addEventListener('click', async ()=>{
      const text=messageInput.value.trim();
      if(!text) return;
      appendMessage('user',text);
      chatHistory.push({role:'user',content:text});
      messageInput.value='';
      const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,persona:{},history:chatHistory})});
      const data=await res.json();
      if(data.response){
        appendMessage('ai',data.response);
        chatHistory.push({role:'assistant',content:data.response});
        changeEmotion(data.emotion||'neutral');
        speak(data.response);
      }
    });
    messageInput.addEventListener('keypress',e=>{ if(e.key==='Enter') sendButton.click(); });

    function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result.split(',')[1]);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    generateButton.addEventListener('click', async ()=>{
      const prompt = promptInput.value.trim();
      if(!prompt && imageInput.files.length===0) return;
      let imageData='';
      if(imageInput.files.length>0){
        imageData = await fileToBase64(imageInput.files[0]);
      }
      const animate = animateCheckbox.checked;
      const res = await fetch('/api/generate-character-image',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({prompt,image:imageData,animate})
      });
      const data = await res.json();
      if(data.image){
        characterImage.src=`data:image/png;base64,${data.image}`;
      }else if(data.frames){
        let idx=0;
        setInterval(()=>{
          characterImage.src=`data:image/png;base64,${data.frames[idx%data.frames.length]}`;
          idx++;
        },300);
      }
    });
  </script>
</body>
</html>
